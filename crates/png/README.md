# PNG: Portable Network Graphics

圧縮アルゴリズムとしてDeflate圧縮を使用した画像フォーマット。

- 仕様書: https://www.w3.org/TR/png/

# ファイル構造

## シグネチャ

ファイルがpngフォーマットであることを表す、ファイルの先頭8byteの領域。

## チャンク

シグネチャ以降はすべてチャンクと呼ばれる構造の繰り返しである。

チャンクは以下の構造を持つ。

| オフセット[byte] | サイズ[byte] | 内容      |
|-------------|-----------|---------|
| 0           | 4         | データ長    |
| 4           | 4         | チャンクタイプ |
| 8           | データ長      | データ     |
| 8+データ長      | 4         | CRC32   |

データ長はデータ部のみのバイトサイズであり、その他の領域を含めたチャンク全体のサイズはデータ長+12byteである。

チャンクタイプは4byteのASCII文字列であり、チャンクの種類を表す。

読み込みに最低限必要なチャンクは次の3つのみ

### IHDR

画像の基本情報を含むチャンク。必ずシグネチャの直後に一つ配置される。
画像サイズ、ビット深度、圧縮方法などの情報が含まれている。

### IDAT

Deflate圧縮によって圧縮された画像データを含むチャンク。 1つの画像ファイルが複数のIDATチャンクを含んでいる場合がある。

### IEND

画像データの終端を示すチャンク。必ず最後に配置される。

# 読み込みの流れ

1. IHDRチャンクを読む

   画像サイズやビット深度を取得する。

   数値はすべてビッグエンディアンなので注意。
   https://www.w3.org/TR/png/#7Integers-and-byte-order

2. IDATチャンクをすべて読み、画像データを集める

   IENDチャンクを見つけるまで、IDATチャンクを探し、順につなげて圧縮済み画像データのバイナリ列を取得する。

3. 画像を復元する

    1. Deflate圧縮済みのデータを解答する

       https://www.w3.org/TR/2003/REC-PNG-20031110/#10Compression

    2. フィルタリングを解除する

       画像データは圧縮効率向上のためにフィルタ処理を施されている。
       フィルタ処理前のデータを復元することで元の画像データが得られる。

       https://www.w3.org/TR/2003/REC-PNG-20031110/#9Filters


